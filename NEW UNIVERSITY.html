<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>University Academic Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f0f4f8; }
        .bg-primary-gold { background-color: #FFD700; }
        .text-primary-gold { color: #FFD700; }
        .bg-primary-blue { background-color: #003366; }
        .text-primary-blue { color: #003366; }
        .border-primary-gold { border-color: #FFD700; }
        .border-primary-blue { border-color: #003366; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #003366; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #002244; }
        .page { display: none; }
        .page.active { display: block; }
        .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); justify-content: center; align-items: center; }
        .modal.flex { display: flex; }
        .modal-content { background-color: #fefefe; margin: auto; padding: 2rem; border: 1px solid #888; width: 90%; max-width: 600px; border-radius: 1rem; position: relative; }
        .close-button { color: #aaa; position: absolute; top: 1rem; right: 1rem; font-size: 28px; font-weight: bold; cursor: pointer; }
        .close-button:hover, .close-button:focus { color: black; }
        .tab-button.active { border-bottom: 2px solid #FFD700; color: #003366; font-weight: 600; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
    </style>
</head>
<body class="bg-gray-100">

    <!-- Login Page -->
    <div id="login-page" class="page active">
        <div class="min-h-screen flex items-center justify-center bg-primary-blue">
            <div class="w-full max-w-md p-8 space-y-8 bg-white rounded-2xl shadow-2xl">
                <div class="text-center"><h1 class="text-4xl font-bold text-primary-blue">University Portal</h1><p class="mt-2 text-gray-600">Sign in to your account</p></div>
                <form class="space-y-6" onsubmit="event.preventDefault(); handleLogin();">
                    <div><label for="username" class="block text-sm font-medium text-gray-700">Username</label><input type="text" id="username" name="username" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary-blue focus:border-primary-blue" required></div>
                    <div><label for="password" class="block text-sm font-medium text-gray-700">Password</label><input type="password" id="password" name="password" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary-blue focus:border-primary-blue" required></div>
                    <p id="login-error" class="text-red-500 text-sm mt-2 hidden">Invalid username or password.</p>
                    <button type="submit" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-primary-gold hover:bg-yellow-400 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-gold transition duration-150">Sign In</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Student Dashboard -->
    <div id="student-dashboard" class="page">
        <header id="student-header" class="bg-primary-blue shadow-md"></header>
        <main class="container mx-auto p-4 sm:p-6 lg:p-8">
            <div class="mb-6 border-b border-gray-300"><nav class="flex space-x-8" aria-label="Tabs"><button onclick="switchStudentTab('overview')" class="tab-button active py-4 px-1 text-lg font-medium text-gray-500 hover:text-primary-blue">Overview</button><button onclick="switchStudentTab('enrollment')" class="tab-button py-4 px-1 text-lg font-medium text-gray-500 hover:text-primary-blue">Enrollment</button><button onclick="switchStudentTab('curriculum')" class="tab-button py-4 px-1 text-lg font-medium text-gray-500 hover:text-primary-blue">Curriculum</button></nav></div>
            <div id="student-overview-tab" class="tab-content active"><div class="grid grid-cols-1 lg:grid-cols-3 gap-8"><div class="lg:col-span-1 space-y-8"><div id="student-info-card" class="bg-white p-6 rounded-lg shadow-md"></div><div id="student-gpa-card" class="bg-white p-6 rounded-lg shadow-md"></div><div id="student-awards-card" class="bg-white p-6 rounded-lg shadow-md"></div></div><div id="student-grades-container" class="lg:col-span-2 space-y-8"></div></div></div>
            <div id="student-enrollment-tab" class="tab-content"><div id="student-enrollment-container" class="bg-white p-6 rounded-lg shadow-md"></div></div>
            <div id="student-curriculum-tab" class="tab-content"><div id="student-curriculum-container" class="bg-white p-6 rounded-lg shadow-md"></div></div>
        </main>
    </div>

    <!-- Alumni Dashboard -->
    <div id="alumni-dashboard" class="page">
        <header id="alumni-header" class="bg-primary-blue shadow-md"></header>
        <main class="container mx-auto p-4 sm:p-6 lg:p-8">
            <div class="text-center mb-8">
                <h1 class="text-4xl font-bold text-primary-blue">Academic Journey</h1>
                <p class="text-gray-600">A look back at your achievements.</p>
            </div>
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <div class="lg:col-span-1 space-y-8">
                    <div id="alumni-info-card" class="bg-white p-6 rounded-lg shadow-md"></div>
                    <div id="alumni-awards-card" class="bg-white p-6 rounded-lg shadow-md"></div>
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h2 class="text-xl font-bold text-primary-blue mb-4">Documents</h2>
                        <div class="space-y-4">
                            <button onclick="downloadDiploma()" class="w-full flex items-center justify-center bg-primary-blue text-white py-3 rounded-md hover:bg-blue-800 transition"><i class="fas fa-file-pdf mr-2"></i>Download Diploma</button>
                            <button onclick="downloadTranscript()" class="w-full flex items-center justify-center bg-primary-gold text-white py-3 rounded-md hover:bg-yellow-400 transition"><i class="fas fa-file-alt mr-2"></i>Download Transcript</button>
                        </div>
                    </div>
                </div>
                <div id="alumni-grades-container" class="lg:col-span-2 space-y-6"></div>
            </div>
        </main>
    </div>

    <!-- Professor Dashboard -->
    <div id="professor-dashboard" class="page">
        <header id="professor-header" class="bg-primary-blue shadow-md"></header>
        <main class="container mx-auto p-4 sm:p-6 lg:p-8"><h2 class="text-2xl font-bold text-primary-blue mb-6">My Classes</h2><div id="professor-classes-container" class="space-y-8"></div></main>
    </div>

    <!-- Registrar Dashboard -->
    <div id="registrar-dashboard" class="page">
        <header id="registrar-header" class="bg-primary-blue shadow-md"></header>
        <main class="container mx-auto p-4 sm:p-6 lg:p-8">
            <div class="mb-6 border-b border-gray-300"><nav class="flex space-x-8" aria-label="Tabs"><button onclick="switchRegistrarTab('management')" class="tab-button active py-4 px-1 text-lg font-medium text-gray-500 hover:text-primary-blue">Management</button><button onclick="switchRegistrarTab('alumni')" class="tab-button py-4 px-1 text-lg font-medium text-gray-500 hover:text-primary-blue">Alumni</button><button onclick="switchRegistrarTab('logs')" class="tab-button py-4 px-1 text-lg font-medium text-gray-500 hover:text-primary-blue">System Logs</button></nav></div>
            <div id="registrar-management-tab" class="tab-content active">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-8 mb-8"><div class="bg-white p-6 rounded-lg shadow-md"><h2 class="text-xl font-bold text-primary-blue mb-4">User Management</h2><div class="space-y-4"><button onclick="openModal('add-student-modal')" class="w-full bg-primary-blue text-white py-2 rounded-md hover:bg-blue-800 transition">Add Student</button><button onclick="openModal('add-professor-modal')" class="w-full bg-primary-blue text-white py-2 rounded-md hover:bg-blue-800 transition">Add Professor</button></div></div><div class="bg-white p-6 rounded-lg shadow-md"><h2 class="text-xl font-bold text-primary-blue mb-4">Course Management</h2><button onclick="openModal('add-course-modal')" class="w-full bg-primary-blue text-white py-2 rounded-md hover:bg-blue-800 transition">Create Course</button></div><div class="bg-white p-6 rounded-lg shadow-md"><h2 class="text-xl font-bold text-primary-blue mb-4">Adjustment Period</h2><div id="adjustment-period-toggle" class="flex items-center justify-center"></div></div></div>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8"><div id="registrar-students-list" class="bg-white p-6 rounded-lg shadow-md lg:col-span-1"></div><div id="registrar-courses-list" class="bg-white p-6 rounded-lg shadow-md lg:col-span-1"></div><div id="registrar-ranking-list" class="bg-white p-6 rounded-lg shadow-md lg:col-span-1"></div></div>
            </div>
            <div id="registrar-alumni-tab" class="tab-content"><div id="registrar-alumni-container" class="bg-white p-6 rounded-lg shadow-md"></div></div>
            <div id="registrar-logs-tab" class="tab-content"><div id="registrar-logs-container" class="bg-white p-6 rounded-lg shadow-md"></div></div>
        </main>
    </div>

    <!-- Modals -->
    <div id="add-student-modal" class="modal"><div class="modal-content"><span class="close-button" onclick="closeModal('add-student-modal')">&times;</span><h3 class="text-xl font-bold text-primary-blue mb-4">Add New Student</h3><form id="add-student-form" class="space-y-4"><input type="text" id="student-name" placeholder="Full Name" class="w-full p-2 border rounded" required><input type="text" id="student-id" placeholder="Student ID (e.g., 2024-0001)" class="w-full p-2 border rounded" required><input type="text" id="student-program" placeholder="Program (e.g., BSCS)" class="w-full p-2 border rounded" required><select id="student-year" class="w-full p-2 border rounded" required><option value="1">1st Year</option><option value="2">2nd Year</option><option value="3">3rd Year</option><option value="4">4th Year</option></select><input type="text" id="student-username" placeholder="Username" class="w-full p-2 border rounded" required><input type="password" id="student-password" placeholder="Password" class="w-full p-2 border rounded" required><button type="submit" class="w-full bg-primary-gold text-white py-2 rounded-md">Add Student</button></form></div></div>
    <div id="add-professor-modal" class="modal"><div class="modal-content"><span class="close-button" onclick="closeModal('add-professor-modal')">&times;</span><h3 class="text-xl font-bold text-primary-blue mb-4">Add New Professor</h3><form id="add-professor-form" class="space-y-4"><input type="text" id="prof-name" placeholder="Full Name (e.g., Dr. Alan Turing)" class="w-full p-2 border rounded" required><input type="text" id="prof-id" placeholder="Professor ID (e.g., P-101)" class="w-full p-2 border rounded" required><input type="text" id="prof-department" placeholder="Department" class="w-full p-2 border rounded" required><input type="text" id="prof-username" placeholder="Username" class="w-full p-2 border rounded" required><input type="password" id="prof-password" placeholder="Password" class="w-full p-2 border rounded" required><button type="submit" class="w-full bg-primary-gold text-white py-2 rounded-md">Add Professor</button></form></div></div>
    <div id="add-course-modal" class="modal"><div class="modal-content"><span class="close-button" onclick="closeModal('add-course-modal')">&times;</span><h3 class="text-xl font-bold text-primary-blue mb-4">Create New Course</h3><form id="add-course-form" class="space-y-4"><input type="text" id="course-name" placeholder="Course Name (e.g., Data Structures)" class="w-full p-2 border rounded" required><input type="text" id="course-code" placeholder="Course Code (e.g., CS201)" class="w-full p-2 border rounded" required><select id="course-year" class="w-full p-2 border rounded" required><option value="" disabled selected>Select Year Level</option><option value="1">1st Year</option><option value="2">2nd Year</option><option value="3">3rd Year</option><option value="4">4th Year</option></select><select id="course-professor" class="w-full p-2 border rounded" required></select><div class="flex items-center"><input type="checkbox" id="course-mandatory" class="h-4 w-4 text-primary-blue border-gray-300 rounded"><label for="course-mandatory" class="ml-2 block text-sm text-gray-900">Mandatory (GEED)</label></div><button type="submit" class="w-full bg-primary-gold text-white py-2 rounded-md">Create Course</button></form></div></div>
    <div id="edit-grades-modal" class="modal"><div class="modal-content"><span class="close-button" onclick="closeModal('edit-grades-modal')">&times;</span><h3 class="text-xl font-bold text-primary-blue mb-4">Edit Grades for <span id="grade-student-name"></span></h3><form id="edit-grades-form" class="space-y-4"><input type="hidden" id="grade-student-id"><input type="hidden" id="grade-course-id"><div class="grid grid-cols-2 gap-4"><div><label>Quizzes (comma-sep)</label><input type="text" id="quizzes-grades" placeholder="e.g. 1.50, 2.00, 1.00" class="w-full p-2 border rounded"></div><div><label>Assignments (comma-sep)</label><input type="text" id="assignments-grades" placeholder="e.g. 1.00, 1.25" class="w-full p-2 border rounded"></div></div><div><label>Project</label><input type="number" step="0.25" min="1" max="5" id="project-grade" class="w-full p-2 border rounded"></div><div class="grid grid-cols-2 gap-4"><div><label>Midterm Grade</label><select id="midterm-grade" class="w-full p-2 border rounded"><option value="">N/A</option><option value="1.00">1.00</option><option value="1.25">1.25</option><option value="1.50">1.50</option><option value="1.75">1.75</option><option value="2.00">2.00</option><option value="2.25">2.25</option><option value="2.50">2.50</option><option value="2.75">2.75</option><option value="3.00">3.00</option><option value="5.00">5.00 (Fail)</option></select></div><div><label>Final Exam Grade</label><select id="final-grade" class="w-full p-2 border rounded"><option value="">N/A</option><option value="1.00">1.00</option><option value="1.25">1.25</option><option value="1.50">1.50</option><option value="1.75">1.75</option><option value="2.00">2.00</option><option value="2.25">2.25</option><option value="2.50">2.50</option><option value="2.75">2.75</option><option value="3.00">3.00</option><option value="5.00">5.00 (Fail)</option></select></div></div><button type="submit" class="w-full bg-primary-gold text-white py-2 rounded-md">Save Grades</button></form></div></div>
    <div id="promote-student-modal" class="modal"><div class="modal-content"><span class="close-button" onclick="closeModal('promote-student-modal')">&times;</span><h3 class="text-xl font-bold text-primary-blue mb-4">Promote Student</h3><p>Promote <strong id="promote-student-name-modal"></strong> to the next year level?</p><p class="text-sm text-gray-600 mb-4">Eligibility: <span id="promotion-eligibility"></span></p><form id="promote-student-form"><input type="hidden" id="promote-student-id"><button type="submit" id="promote-confirm-button" class="w-full bg-primary-gold text-white py-2 rounded-md">Confirm Promotion</button></form></div></div>
    <div id="graduate-student-modal" class="modal"><div class="modal-content"><span class="close-button" onclick="closeModal('graduate-student-modal')">&times;</span><h3 class="text-xl font-bold text-primary-blue mb-4">Graduate Student</h3><p>Mark <strong id="graduate-student-name"></strong> as Graduated?</p><p class="text-sm text-gray-600 mb-4">Eligibility: <span id="graduation-eligibility"></span></p><form id="graduate-student-form"><input type="hidden" id="graduate-student-id"><button type="submit" id="graduate-confirm-button" class="w-full bg-primary-gold text-white py-2 rounded-md">Confirm Graduation</button></form></div></div>
    <div id="class-analytics-modal" class="modal"><div class="modal-content"><span class="close-button" onclick="closeModal('class-analytics-modal')">&times;</span><h3 class="text-xl font-bold text-primary-blue mb-4">Class Analytics: <span id="analytics-course-name"></span></h3><div style="width: 100%; max-width: 500px;"><canvas id="grade-distribution-chart"></canvas></div><div id="analytics-summary" class="mt-4 text-center"></div></div></div>
    <div id="award-honor-modal" class="modal"><div class="modal-content"><span class="close-button" onclick="closeModal('award-honor-modal')">&times;</span><h3 class="text-xl font-bold text-primary-blue mb-4">Award Subject Honor</h3><p>For <strong id="award-student-name"></strong> in <strong id="award-course-name"></strong></p><form id="award-honor-form" class="space-y-4 mt-4"><input type="hidden" id="award-student-id"><input type="hidden" id="award-course-id"><input type="text" id="award-title" placeholder="e.g., Best in Thesis" class="w-full p-2 border rounded" required><button type="submit" class="w-full bg-primary-gold text-white py-2 rounded-md">Grant Award</button></form></div></div>

    <script>
    const { jsPDF } = window.jspdf;
    // --- Local Storage Database Simulation ---
    const DB = {
        _get: (key) => JSON.parse(localStorage.getItem(key)) || [],
        _set: (key, data) => localStorage.setItem(key, JSON.stringify(data)),
        getUsers: () => DB._get('users'),
        setUsers: (data) => DB._set('users', data),
        getCourses: () => DB._get('courses'),
        setCourses: (data) => DB._set('courses', data),
        getEnrollments: () => DB._get('enrollments'),
        setEnrollments: (data) => DB._set('enrollments', data),
        getSettings: () => JSON.parse(localStorage.getItem('settings')) || { adjustmentPeriodActive: false },
        setSettings: (data) => localStorage.setItem('settings', JSON.stringify(data)),
        getLogs: () => DB._get('logs'),
        addLog: (message) => { const logs = DB.getLogs(); logs.unshift({ message, timestamp: new Date().toISOString() }); DB._set('logs', logs.slice(0, 50)); },
        getCurrentUser: () => JSON.parse(sessionStorage.getItem('currentUser')),
        setCurrentUser: (user) => sessionStorage.setItem('currentUser', JSON.stringify(user)),
        clearCurrentUser: () => sessionStorage.removeItem('currentUser'),
        init: () => {
            if (!localStorage.getItem('users')) DB.setUsers([{ username: 'registrar', password: 'password', role: 'registrar', details: { name: 'Registrar Admin' } }]);
            if (!localStorage.getItem('settings')) DB.setSettings({ adjustmentPeriodActive: false });
            if (!localStorage.getItem('logs')) DB._set('logs', []);
        }
    };

    // --- Page Navigation & Auth ---
    function showPage(pageId) { document.querySelectorAll('.page').forEach(p => p.classList.remove('active')); document.getElementById(pageId)?.classList.add('active'); }
    function handleLogin() {
        const user = DB.getUsers().find(u => u.username === document.getElementById('username').value && u.password === document.getElementById('password').value);
        const loginError = document.getElementById('login-error');
        loginError.classList.add('hidden');
        if (user) {
            DB.setCurrentUser(user);
            if (user.status === 'graduated') {
                renderAlumniDashboard();
                showPage('alumni-dashboard');
            } else {
                const renderFunc = window[`render${user.role.charAt(0).toUpperCase() + user.role.slice(1)}Dashboard`];
                if (renderFunc) renderFunc();
                showPage(`${user.role}-dashboard`);
            }
        } else {
            loginError.textContent = 'Invalid username or password.';
            loginError.classList.remove('hidden');
        }
    }
    function logout() { DB.clearCurrentUser(); document.getElementById('username').value = ''; document.getElementById('password').value = ''; showPage('login-page'); }
    function createHeader(role, name) { return `<div class="container mx-auto px-4 sm:px-6 lg:px-8"><div class="flex items-center justify-between h-16"><div class="flex items-center"><span class="text-2xl font-bold text-primary-gold">${role.charAt(0).toUpperCase() + role.slice(1)} Dashboard</span></div><div class="flex items-center"><span class="text-white mr-4">Welcome, ${name}!</span><button onclick="logout()" class="text-white hover:text-primary-gold transition"><i class="fas fa-sign-out-alt mr-2"></i>Logout</button></div></div></div>`; }

    // --- Modals ---
    function openModal(modalId) { if (modalId === 'add-course-modal') populateProfessorDropdown(); document.getElementById(modalId)?.classList.add('flex'); }
    function closeModal(modalId) { document.getElementById(modalId)?.classList.remove('flex'); }

    // --- Grade & Award Calculation ---
    const GRADE_WEIGHTS = { quizzes: 0.20, assignments: 0.15, project: 0.25, midterm: 0.20, final: 0.20 };
    function formatGrade(grade) { return grade !== null && grade !== undefined ? parseFloat(grade).toFixed(2) : null; }
    function calculateCourseGrade(grades) {
        if (grades.final === null) return { numeric: null, status: 'Incomplete' };
        const quizAvg = grades.quizzes.length > 0 ? grades.quizzes.reduce((a, b) => a + b, 0) / grades.quizzes.length : 3.00;
        const assignmentAvg = grades.assignments.length > 0 ? grades.assignments.reduce((a, b) => a + b, 0) / grades.assignments.length : 3.00;
        const finalGrade = (quizAvg * GRADE_WEIGHTS.quizzes) + (assignmentAvg * GRADE_WEIGHTS.assignments) + ((grades.project || 3.00) * GRADE_WEIGHTS.project) + ((grades.midterm || 3.00) * GRADE_WEIGHTS.midterm) + ((grades.final || 3.00) * GRADE_WEIGHTS.final);
        const roundedGrade = (Math.round(finalGrade * 4) / 4);
        return { numeric: formatGrade(roundedGrade), status: roundedGrade <= 3.00 ? 'Passed' : 'Failed' };
    }
    function calculateGPA(studentId) {
        const enrollments = DB.getEnrollments().filter(e => e.studentId === studentId);
        const validGrades = enrollments.map(e => parseFloat(calculateCourseGrade(e.grades).numeric)).filter(g => g !== null && !isNaN(g) && g <= 3.00);
        if (validGrades.length === 0) return { gpa: 'N/A', status: 'No grades yet' };
        const gpa = (validGrades.reduce((sum, grade) => sum + grade, 0) / validGrades.length);
        let status = 'Good Standing';
        if (gpa <= 1.50) status = "Dean's Lister";
        if (gpa > 2.50) status = 'Needs Improvement';
        return { gpa: formatGrade(gpa), status };
    }
    function determineLatinHonors(gpa) {
        if (gpa <= 1.20) return "Summa Cum Laude";
        if (gpa <= 1.45) return "Magna Cum Laude";
        if (gpa <= 1.75) return "Cum Laude";
        return null;
    }

    // --- Student Dashboard ---
    function switchStudentTab(tabName) { document.querySelectorAll('#student-dashboard .tab-button').forEach(b => b.classList.remove('active')); document.querySelector(`#student-dashboard .tab-button[onclick="switchStudentTab('${tabName}')"]`).classList.add('active'); document.querySelectorAll('#student-dashboard .tab-content').forEach(c => c.classList.remove('active')); document.getElementById(`student-${tabName}-tab`).classList.add('active'); }
    function renderStudentDashboard() { const user = DB.getCurrentUser(); document.getElementById('student-header').innerHTML = createHeader('student', user.details.name); renderStudentOverview(); renderStudentEnrollmentTab(); renderStudentCurriculumTab(); switchStudentTab('overview'); }
    function renderStudentOverview() {
        const user = DB.getCurrentUser();
        document.getElementById('student-info-card').innerHTML = `<h2 class="text-xl font-bold text-primary-blue mb-4">Student Information</h2><div class="space-y-3"><p><strong>Name:</strong> ${user.details.name}</p><p><strong>Student ID:</strong> ${user.details.id}</p><p><strong>Program:</strong> ${user.details.program}</p><p><strong>Year Level:</strong> ${user.status === 'graduated' ? 'Alumnus/Alumna' : user.details.year}</p></div>`;
        const { gpa, status } = calculateGPA(user.details.id);
        document.getElementById('student-gpa-card').innerHTML = `<h2 class="text-xl font-bold text-primary-blue mb-4">Academic Standing</h2><div class="text-center"><p class="text-4xl font-bold text-primary-blue">${gpa}</p><p class="text-gray-600">${status}</p></div>`;
        let awardsHtml = `<h2 class="text-xl font-bold text-primary-blue mb-4">Awards & Recognition</h2>`;
        if (user.details.awards && user.details.awards.length > 0) { awardsHtml += `<ul class="space-y-2">${user.details.awards.map(award => `<li class="flex items-center text-primary-gold"><i class="fas fa-trophy mr-2"></i> ${award}</li>`).join('')}</ul>`; } else { awardsHtml += `<p class="text-gray-500">No awards yet.</p>`; }
        document.getElementById('student-awards-card').innerHTML = awardsHtml;
        const enrollments = DB.getEnrollments().filter(e => e.studentId === user.details.id);
        const courses = DB.getCourses();
        const users = DB.getUsers();
        let gradesHtml = '';
        if (enrollments.length > 0) {
            enrollments.forEach(enrollment => {
                const course = courses.find(c => c.id === enrollment.courseId);
                const professor = users.find(u => u.details.id === course?.professorId);
                const { numeric: overallGrade, status: gradeStatus } = calculateCourseGrade(enrollment.grades);
                const adjustmentPeriodActive = DB.getSettings().adjustmentPeriodActive;
                gradesHtml += `<div class="bg-white p-6 rounded-lg shadow-md"><div class="flex justify-between items-start"><div><h3 class="text-xl font-bold text-primary-blue">${course?.name} (${course?.code})</h3><p class="text-sm text-gray-500 mb-4">Prof. ${professor?.details.name}</p></div><div class="text-right"><p class="text-2xl font-bold ${gradeStatus === 'Failed' ? 'text-red-500' : 'text-primary-blue'}">${overallGrade || 'TBD'}</p><p class="text-sm ${gradeStatus === 'Failed' ? 'text-red-500' : 'text-gray-500'}">${gradeStatus}</p></div></div><div><h4 class="font-semibold mb-2">Grade Details:</h4><ul class="text-sm space-y-1"><li>Quizzes: ${enrollment.grades.quizzes.map(formatGrade).join(', ') || 'N/A'}</li><li>Assignments: ${enrollment.grades.assignments.map(formatGrade).join(', ') || 'N/A'}</li><li>Project: ${formatGrade(enrollment.grades.project) || 'N/A'}</li><li>Midterm: ${formatGrade(enrollment.grades.midterm) || 'N/A'}</li><li>Final Exam: ${formatGrade(enrollment.grades.final) || 'N/A'}</li></ul></div>${adjustmentPeriodActive && user.status !== 'graduated' ? `<button onclick="dropCourse('${enrollment.studentId}', '${enrollment.courseId}', 'student')" class="mt-4 w-full bg-red-500 text-white py-2 rounded-md hover:bg-red-600 transition">Drop Course</button>` : ''}</div>`;
            });
        } else { gradesHtml = `<div class="bg-white p-6 rounded-lg shadow-md text-center"><p class="text-gray-500">You are not enrolled in any courses.</p></div>`; }
        document.getElementById('student-grades-container').innerHTML = gradesHtml;
    }
    function renderStudentEnrollmentTab() {
        const user = DB.getCurrentUser();
        const availableCourses = DB.getCourses().filter(c => (c.year === user.details.year || c.isMandatory) && !DB.getEnrollments().some(e => e.studentId === user.details.id && e.courseId === c.id));
        let html = `<h2 class="text-2xl font-bold text-primary-blue mb-6">Course Registration</h2>`;
        if (user.status === 'graduated') { html += `<p class="text-gray-500">Enrollment is closed for alumni.</p>`; } else if (availableCourses.length > 0) { html += `<div class="space-y-4">${availableCourses.map(course => `<div class="p-4 border rounded-lg flex justify-between items-center"><div><p class="font-bold">${course.name} (${course.code})</p><p class="text-sm text-gray-600">${course.isMandatory ? 'Mandatory GEED' : `${course.year} Year Course`}</p></div><button onclick="enrollCourse('${user.details.id}', '${course.id}')" class="bg-primary-gold text-white px-4 py-2 rounded-md hover:bg-yellow-400">Enroll</button></div>`).join('')}</div>`; } else { html += `<p class="text-gray-500">No new courses available for enrollment.</p>`; }
        document.getElementById('student-enrollment-container').innerHTML = html;
    }
    function renderStudentCurriculumTab() {
        const user = DB.getCurrentUser();
        const allCourses = DB.getCourses();
        const myEnrollments = DB.getEnrollments().filter(e => e.studentId === user.details.id);
        let html = `<h2 class="text-2xl font-bold text-primary-blue mb-6">Curriculum Checklist</h2><div class="space-y-6">`;
        for (let yr = 1; yr <= 4; yr++) {
            html += `<div><h3 class="text-xl font-semibold text-primary-blue border-b-2 border-primary-gold pb-2 mb-3">${yr}${yr === 1 ? 'st' : yr === 2 ? 'nd' : yr === 3 ? 'rd' : 'th'} Year</h3><ul class="space-y-2">`;
            const yearCourses = allCourses.filter(c => c.year == yr || (c.isMandatory && yr == 1));
            yearCourses.forEach(course => {
                const enrollment = myEnrollments.find(e => e.courseId === course.id);
                const gradeInfo = enrollment ? calculateCourseGrade(enrollment.grades) : null;
                const status = gradeInfo?.status === 'Passed' ? 'text-green-500' : (enrollment ? 'text-red-500' : 'text-gray-400');
                const icon = gradeInfo?.status === 'Passed' ? 'fa-check-circle' : (enrollment ? 'fa-times-circle' : 'fa-circle');
                html += `<li class="flex items-center"><i class="fas ${icon} ${status} mr-3"></i>${course.name} (${course.code})</li>`;
            });
            html += `</ul></div>`;
        }
        html += `</div>`;
        document.getElementById('student-curriculum-container').innerHTML = html;
    }
    function enrollCourse(studentId, courseId) { let enrollments = DB.getEnrollments(); enrollments.push({ studentId, courseId, grades: { quizzes: [], assignments: [], project: null, midterm: null, final: null } }); DB.setEnrollments(enrollments); DB.addLog(`Student ${studentId} enrolled in course ${courseId}.`); alert('Enrolled successfully!'); renderStudentDashboard(); }
    function dropCourse(studentId, courseId, droppedBy) { if (!confirm('Are you sure you want to drop this course?')) return; DB.setEnrollments(DB.getEnrollments().filter(e => !(e.studentId === studentId && e.courseId === courseId))); DB.addLog(`Student ${studentId} dropped course ${courseId} by ${droppedBy}.`); alert('Course dropped successfully.'); if (droppedBy === 'student') { renderStudentDashboard(); } else { renderProfessorDashboard(); } }

    // --- Professor Dashboard ---
    function renderProfessorDashboard() {
        const user = DB.getCurrentUser();
        document.getElementById('professor-header').innerHTML = createHeader('professor', user.details.name);
        const courses = DB.getCourses().filter(c => c.professorId === user.details.id);
        const adjustmentPeriodActive = DB.getSettings().adjustmentPeriodActive;
        let containerHtml = '';
        if (courses.length > 0) {
            courses.forEach(course => {
                const enrolledStudents = DB.getEnrollments().filter(e => e.courseId === course.id);
                const students = DB.getUsers().filter(u => enrolledStudents.some(e => e.studentId === u.details.id) && u.status !== 'graduated' && u.details.year === course.year);
                containerHtml += `<div class="bg-white p-6 rounded-lg shadow-md"><div class="flex justify-between items-center mb-4"><h3 class="text-xl font-bold text-primary-blue">${course.code}: ${course.name}</h3><button onclick="openClassAnalyticsModal('${course.id}')" class="text-sm bg-primary-gold text-white px-3 py-1 rounded-md hover:bg-yellow-400">Analytics</button></div><div class="overflow-x-auto"><table class="min-w-full bg-white"><thead class="bg-gray-50"><tr><th class="py-3 px-4 text-left">Student</th><th class="py-3 px-4 text-center">Final Grade</th><th class="py-3 px-4 text-center">Status</th><th class="py-3 px-4 text-center">Actions</th></tr></thead><tbody class="divide-y divide-gray-200">`;
                if (students.length > 0) {
                    students.forEach(student => {
                        const enrollment = enrolledStudents.find(e => e.studentId === student.details.id);
                        const { numeric: finalGrade, status } = calculateCourseGrade(enrollment.grades);
                        containerHtml += `<tr><td class="py-4 px-4">${student.details.name}</td><td class="py-4 px-4 text-center font-bold">${finalGrade || 'N/A'}</td><td class="py-4 px-4 text-center">${status}</td><td class="py-4 px-4 text-center space-x-2"><button onclick="openEditGradesModal('${student.details.id}', '${course.id}')" class="text-blue-600 hover:text-blue-900" title="Edit Grades"><i class="fas fa-edit"></i></button><button onclick="openAwardHonorModal('${student.details.id}', '${course.id}')" class="text-yellow-500 hover:text-yellow-700" title="Award Honor"><i class="fas fa-trophy"></i></button>${adjustmentPeriodActive ? `<button onclick="dropCourse('${student.details.id}', '${course.id}', 'professor')" class="text-red-600 hover:text-red-900" title="Drop Student"><i class="fas fa-user-slash"></i></button>` : ''}</td></tr>`;
                    });
                } else { containerHtml += `<tr><td colspan="4" class="text-center py-4">No active students in this class.</td></tr>`; }
                containerHtml += `</tbody></table></div></div>`;
            });
        } else { containerHtml = `<p class="text-gray-500">You are not assigned to any courses.</p>`; }
        document.getElementById('professor-classes-container').innerHTML = containerHtml;
    }
    
    // --- Registrar Dashboard ---
    function switchRegistrarTab(tabName) { document.querySelectorAll('#registrar-dashboard .tab-button').forEach(b => b.classList.remove('active')); document.querySelector(`#registrar-dashboard .tab-button[onclick="switchRegistrarTab('${tabName}')"]`).classList.add('active'); document.querySelectorAll('#registrar-dashboard .tab-content').forEach(c => c.classList.remove('active')); document.getElementById(`registrar-${tabName}-tab`).classList.add('active'); }
    function renderRegistrarDashboard() { document.getElementById('registrar-header').innerHTML = createHeader('registrar', 'Admin'); renderRegistrarManagementTab(); renderRegistrarAlumniTab(); renderRegistrarLogsTab(); switchRegistrarTab('management'); }
    function renderRegistrarManagementTab() {
        const users = DB.getUsers();
        const courses = DB.getCourses();
        let studentsHtml = `<h3 class="text-lg font-bold text-primary-blue mb-2">Active Students</h3><div class="space-y-2">`;
        users.filter(u => u.role === 'student' && u.status !== 'graduated').forEach(s => {
            const actionButton = s.details.year == '4'
                ? `<button onclick="openGraduateStudentModal('${s.details.id}')" class="text-xs bg-green-500 text-white px-2 py-1 rounded hover:bg-green-600">Graduate</button>`
                : `<button onclick="openPromoteStudentModal('${s.details.id}')" class="text-xs bg-blue-500 text-white px-2 py-1 rounded hover:bg-blue-600">Promote</button>`;
            studentsHtml += `<div class="p-2 border rounded flex justify-between items-center"><span>${s.details.name} (${s.details.year} Yr)</span>${actionButton}</div>`;
        });
        document.getElementById('registrar-students-list').innerHTML = studentsHtml + `</div>`;
        let coursesHtml = `<h3 class="text-lg font-bold text-primary-blue mb-2">Courses</h3><div class="space-y-4">`;
        for (let yr = 1; yr <= 4; yr++) {
            coursesHtml += `<div><h4 class="font-semibold">${yr}${yr === 1 ? 'st' : yr === 2 ? 'nd' : yr === 3 ? 'rd' : 'th'} Year</h4><ul class="divide-y divide-gray-200">`;
            courses.filter(c => c.year == yr).forEach(c => { coursesHtml += `<li class="py-1 text-sm">${c.name} (${c.code}) ${c.isMandatory ? ' (GEED)' : ''}</li>`; });
            coursesHtml += `</ul></div>`;
        }
        document.getElementById('registrar-courses-list').innerHTML = coursesHtml + `</div>`;
        let rankingHtml = `<h3 class="text-lg font-bold text-primary-blue mb-2">Student Rankings</h3><ol class="list-decimal list-inside space-y-2">`;
        users.filter(u => u.role === 'student' && u.status !== 'graduated').map(s => ({ ...s, gpa: parseFloat(calculateGPA(s.details.id).gpa) })).filter(s => !isNaN(s.gpa)).sort((a, b) => a.gpa - b.gpa).forEach(s => { rankingHtml += `<li class="p-2 border rounded">${s.details.name} - <strong>${s.gpa.toFixed(2)}</strong></li>`; });
        document.getElementById('registrar-ranking-list').innerHTML = rankingHtml + `</ol>`;
        renderAdjustmentPeriodToggle();
    }
    function renderRegistrarAlumniTab() {
        const alumni = DB.getUsers().filter(u => u.status === 'graduated');
        let html = `<h2 class="text-2xl font-bold text-primary-blue mb-6">Alumni List</h2>`;
        if (alumni.length > 0) {
            html += `<div class="overflow-x-auto"><table class="min-w-full bg-white"><thead class="bg-gray-50"><tr><th class="py-3 px-4 text-left">Name</th><th class="py-3 px-4 text-left">Program</th><th class="py-3 px-4 text-left">Graduation Date</th><th class="py-3 px-4 text-left">Honors</th></tr></thead><tbody class="divide-y divide-gray-200">`;
            alumni.forEach(user => { html += `<tr><td class="py-4 px-4">${user.details.name}</td><td class="py-4 px-4">${user.details.program}</td><td class="py-4 px-4">${new Date(user.graduationDate).toLocaleDateString()}</td><td class="py-4 px-4 font-semibold text-primary-gold">${user.details.awards?.join(', ') || 'N/A'}</td></tr>`; });
            html += `</tbody></table></div>`;
        } else { html += `<p class="text-gray-500">No students have graduated yet.</p>`; }
        document.getElementById('registrar-alumni-container').innerHTML = html;
    }
    function renderRegistrarLogsTab() { const logs = DB.getLogs(); let html = `<h2 class="text-2xl font-bold text-primary-blue mb-6">System Activity Logs</h2><ul class="space-y-2">`; logs.forEach(log => { html += `<li class="p-2 border rounded text-sm"><span class="font-mono text-gray-500">${new Date(log.timestamp).toLocaleString()}</span>: ${log.message}</li>`; }); document.getElementById('registrar-logs-container').innerHTML = html + `</ul>`; }
    function renderAdjustmentPeriodToggle() { const settings = DB.getSettings(); document.getElementById('adjustment-period-toggle').innerHTML = `<button onclick="toggleAdjustmentPeriod()" class="px-4 py-2 rounded-md text-white ${settings.adjustmentPeriodActive ? 'bg-red-500' : 'bg-green-500'}">${settings.adjustmentPeriodActive ? 'Deactivate' : 'Activate'}</button>`; }
    function toggleAdjustmentPeriod() { let settings = DB.getSettings(); settings.adjustmentPeriodActive = !settings.adjustmentPeriodActive; DB.setSettings(settings); renderAdjustmentPeriodToggle(); DB.addLog(`Adjustment Period ${settings.adjustmentPeriodActive ? 'activated' : 'deactivated'}.`); alert(`Adjustment period is now ${settings.adjustmentPeriodActive ? 'ACTIVE' : 'INACTIVE'}.`); }

    // --- Alumni Dashboard ---
    function renderAlumniDashboard() {
        const user = DB.getCurrentUser();
        document.getElementById('alumni-header').innerHTML = createHeader('Alumni', user.details.name);
        const { gpa } = calculateGPA(user.details.id);
        document.getElementById('alumni-info-card').innerHTML = `<h2 class="text-xl font-bold text-primary-blue mb-4">Profile</h2><div class="space-y-3"><p><strong>Name:</strong> ${user.details.name}</p><p><strong>Program:</strong> ${user.details.program}</p><p><strong>Graduated:</strong> ${new Date(user.graduationDate).toLocaleDateString()}</p><p><strong>Final GPA:</strong> <strong class="text-primary-blue">${gpa}</strong></p></div>`;
        let awardsHtml = `<h2 class="text-xl font-bold text-primary-blue mb-4">Awards & Recognition</h2>`;
        if (user.details.awards && user.details.awards.length > 0) { awardsHtml += `<ul class="space-y-2">${user.details.awards.map(award => `<li class="flex items-center text-primary-gold"><i class="fas fa-trophy mr-2"></i> ${award}</li>`).join('')}</ul>`; } else { awardsHtml += `<p class="text-gray-500">No awards on record.</p>`; }
        document.getElementById('alumni-awards-card').innerHTML = awardsHtml;

        const enrollments = DB.getEnrollments().filter(e => e.studentId === user.details.id);
        const courses = DB.getCourses();
        let gradesHtml = '';
        for (let yr = 1; yr <= 4; yr++) {
            gradesHtml += `<div class="bg-white p-6 rounded-lg shadow-md"> <h3 class="text-xl font-semibold text-primary-blue border-b-2 border-primary-gold pb-2 mb-3">${yr}${yr === 1 ? 'st' : yr === 2 ? 'nd' : yr === 3 ? 'rd' : 'th'} Year</h3>`;
            const yearEnrollments = enrollments.filter(e => courses.find(c => c.id === e.courseId)?.year == yr);
            if(yearEnrollments.length > 0) {
                gradesHtml += `<table class="min-w-full">`;
                yearEnrollments.forEach(e => {
                    const course = courses.find(c => c.id === e.courseId);
                    const grade = calculateCourseGrade(e.grades);
                    gradesHtml += `<tr><td class="py-1">${course.name}</td><td class="py-1 text-right font-bold">${grade.numeric}</td></tr>`;
                });
                gradesHtml += `</table>`;
            } else {
                 gradesHtml += `<p class="text-sm text-gray-500">No records for this year.</p>`;
            }
            gradesHtml += `</div>`;
        }
        document.getElementById('alumni-grades-container').innerHTML = gradesHtml;
    }

    // --- Form Handling & Data Manipulation ---
    document.getElementById('add-student-form').addEventListener('submit', e => { e.preventDefault(); let u = DB.getUsers(); const studentName = document.getElementById('student-name').value; u.push({ username: document.getElementById('student-username').value, password: document.getElementById('student-password').value, role: 'student', details: { name: studentName, id: document.getElementById('student-id').value, program: document.getElementById('student-program').value, year: document.getElementById('student-year').value, awards: [] } }); DB.setUsers(u); e.target.reset(); closeModal('add-student-modal'); renderRegistrarManagementTab(); DB.addLog(`New student created: ${studentName}`); alert('Student added!'); });
    document.getElementById('add-professor-form').addEventListener('submit', e => { e.preventDefault(); let u = DB.getUsers(); const profName = document.getElementById('prof-name').value; u.push({ username: document.getElementById('prof-username').value, password: document.getElementById('prof-password').value, role: 'professor', details: { name: profName, id: document.getElementById('prof-id').value, department: document.getElementById('prof-department').value } }); DB.setUsers(u); e.target.reset(); closeModal('add-professor-modal'); renderRegistrarManagementTab(); DB.addLog(`New professor created: ${profName}`); alert('Professor added!'); });
    document.getElementById('add-course-form').addEventListener('submit', e => { e.preventDefault(); let c = DB.getCourses(); const courseName = document.getElementById('course-name').value; c.push({ id: 'C' + Date.now(), name: courseName, code: document.getElementById('course-code').value, year: document.getElementById('course-year').value, professorId: document.getElementById('course-professor').value, isMandatory: document.getElementById('course-mandatory').checked }); DB.setCourses(c); e.target.reset(); closeModal('add-course-modal'); renderRegistrarManagementTab(); DB.addLog(`New course created: ${courseName}`); alert('Course created!'); });
    function openEditGradesModal(studentId, courseId) { const student = DB.getUsers().find(s => s.details.id === studentId); const enrollment = DB.getEnrollments().find(e => e.studentId === studentId && e.courseId === courseId); document.getElementById('grade-student-name').textContent = student.details.name; document.getElementById('grade-student-id').value = studentId; document.getElementById('grade-course-id').value = courseId; document.getElementById('quizzes-grades').value = enrollment.grades.quizzes.join(', '); document.getElementById('assignments-grades').value = enrollment.grades.assignments.join(', '); document.getElementById('project-grade').value = enrollment.grades.project || ''; document.getElementById('midterm-grade').value = formatGrade(enrollment.grades.midterm) || ''; document.getElementById('final-grade').value = formatGrade(enrollment.grades.final) || ''; openModal('edit-grades-modal'); }
    document.getElementById('edit-grades-form').addEventListener('submit', e => {
        e.preventDefault();
        const studentId = document.getElementById('grade-student-id').value;
        const courseId = document.getElementById('grade-course-id').value;
        const enrollments = DB.getEnrollments();
        const enrollmentIndex = enrollments.findIndex(en => en.studentId === studentId && en.courseId === courseId);
        if (enrollmentIndex !== -1) {
            const parseGrades = (str) => str.split(',').map(s => parseFloat(s.trim())).filter(n => !isNaN(n));
            enrollments[enrollmentIndex].grades.quizzes = parseGrades(document.getElementById('quizzes-grades').value);
            enrollments[enrollmentIndex].grades.assignments = parseGrades(document.getElementById('assignments-grades').value);
            enrollments[enrollmentIndex].grades.project = parseFloat(document.getElementById('project-grade').value) || null;
            enrollments[enrollmentIndex].grades.midterm = parseFloat(document.getElementById('midterm-grade').value) || null;
            enrollments[enrollmentIndex].grades.final = parseFloat(document.getElementById('final-grade').value) || null;
            DB.setEnrollments(enrollments);
            closeModal('edit-grades-modal');
            renderProfessorDashboard();
            DB.addLog(`Grades updated for student ${studentId} in course ${courseId}.`);
            alert('Grades updated!');
        }
    });
    function openPromoteStudentModal(studentId) {
        const student = DB.getUsers().find(u => u.details.id === studentId);
        document.getElementById('promote-student-name-modal').textContent = student.details.name;
        document.getElementById('promote-student-id').value = studentId;
        const enrollments = DB.getEnrollments().filter(e => e.studentId === studentId);
        const coursesForYear = DB.getCourses().filter(c => c.year === student.details.year);
        let passedAll = coursesForYear.length > 0;
        for (const course of coursesForYear) { const enrollment = enrollments.find(e => e.courseId === course.id); if (!enrollment || calculateCourseGrade(enrollment.grades).status === 'Failed') { passedAll = false; break; } }
        const eligibilityEl = document.getElementById('promotion-eligibility');
        const buttonEl = document.getElementById('promote-confirm-button');
        eligibilityEl.textContent = passedAll ? "Eligible (passed all subjects for the year)." : "Not Eligible (must pass all subjects).";
        eligibilityEl.className = passedAll ? 'text-green-600' : 'text-red-600';
        buttonEl.disabled = !passedAll;
        openModal('promote-student-modal');
    }
    document.getElementById('promote-student-form').addEventListener('submit', e => {
        e.preventDefault();
        const studentId = document.getElementById('promote-student-id').value;
        let users = DB.getUsers();
        const studentIndex = users.findIndex(u => u.details.id === studentId);
        if (studentIndex !== -1) {
            let currentYear = parseInt(users[studentIndex].details.year);
            if (currentYear < 4) {
                const newYear = currentYear + 1;
                users[studentIndex].details.year = newYear.toString();
                DB.setUsers(users);
                let enrollments = DB.getEnrollments();
                const newYearCourses = DB.getCourses().filter(c => c.year == newYear || c.isMandatory);
                newYearCourses.forEach(course => { if (!enrollments.some(en => en.studentId === studentId && en.courseId === course.id)) { enrollments.push({ studentId, courseId: course.id, grades: { quizzes: [], assignments: [], project: null, midterm: null, final: null } }); } });
                DB.setEnrollments(enrollments);
                DB.addLog(`Student ${users[studentIndex].details.name} promoted to Year ${newYear}.`);
                alert('Student promoted and auto-enrolled in new courses!');
            }
        }
        closeModal('promote-student-modal');
        renderRegistrarManagementTab();
    });
    function openGraduateStudentModal(studentId) {
        const student = DB.getUsers().find(u => u.details.id === studentId);
        document.getElementById('graduate-student-name').textContent = student.details.name;
        document.getElementById('graduate-student-id').value = studentId;
        const allCourses = DB.getCourses();
        const studentEnrollments = DB.getEnrollments().filter(e => e.studentId === studentId);
        let passedAll = true;
        for (const course of allCourses) {
            const isEnrolled = studentEnrollments.some(e => e.courseId === course.id);
            if (!isEnrolled) { passedAll = false; break; }
            const enrollment = studentEnrollments.find(e => e.courseId === course.id);
            if (!enrollment || calculateCourseGrade(enrollment.grades).status === 'Failed') { passedAll = false; break; }
        }
        const eligibilityEl = document.getElementById('graduation-eligibility');
        const buttonEl = document.getElementById('graduate-confirm-button');
        eligibilityEl.textContent = passedAll ? "Eligible (all curriculum subjects passed)." : "Not Eligible (must pass all subjects in curriculum).";
        eligibilityEl.className = passedAll ? 'text-green-600' : 'text-red-600';
        buttonEl.disabled = !passedAll;
        openModal('graduate-student-modal');
    }
    document.getElementById('graduate-student-form').addEventListener('submit', e => {
        e.preventDefault();
        const studentId = document.getElementById('graduate-student-id').value;
        let users = DB.getUsers();
        const studentIndex = users.findIndex(u => u.details.id === studentId);
        if (studentIndex !== -1) {
            users[studentIndex].status = 'graduated';
            users[studentIndex].graduationDate = new Date().toISOString();
            const finalGPA = parseFloat(calculateGPA(studentId).gpa);
            const honor = determineLatinHonors(finalGPA);
            if (honor) { if (!users[studentIndex].details.awards) users[studentIndex].details.awards = []; users[studentIndex].details.awards.push(honor); }
            DB.setUsers(users);
            DB.addLog(`Student ${users[studentIndex].details.name} has graduated ${honor ? `with honors: ${honor}` : ''}.`);
            alert('Student marked as graduated!');
        }
        closeModal('graduate-student-modal');
        renderRegistrarManagementTab();
        renderRegistrarAlumniTab();
    });
    function openAwardHonorModal(studentId, courseId) {
        const student = DB.getUsers().find(u => u.details.id === studentId);
        const course = DB.getCourses().find(c => c.id === courseId);
        document.getElementById('award-student-name').textContent = student.details.name;
        document.getElementById('award-course-name').textContent = course.name;
        document.getElementById('award-student-id').value = studentId;
        document.getElementById('award-course-id').value = courseId;
        openModal('award-honor-modal');
    }
    document.getElementById('award-honor-form').addEventListener('submit', e => {
        e.preventDefault();
        const studentId = document.getElementById('award-student-id').value;
        const awardTitle = document.getElementById('award-title').value;
        const courseName = document.getElementById('award-course-name').textContent;
        let users = DB.getUsers();
        const studentIndex = users.findIndex(u => u.details.id === studentId);
        if (studentIndex !== -1) {
            if (!users[studentIndex].details.awards) users[studentIndex].details.awards = [];
            const fullAwardTitle = `${awardTitle} (${courseName})`;
            if (!users[studentIndex].details.awards.includes(fullAwardTitle)) {
                users[studentIndex].details.awards.push(fullAwardTitle);
                DB.setUsers(users);
                DB.addLog(`Award "${fullAwardTitle}" given to student ${studentId}.`);
                alert('Award granted successfully!');
            } else {
                alert('This award has already been given.');
            }
        }
        e.target.reset();
        closeModal('award-honor-modal');
    });
    let gradeChart = null;
    function openClassAnalyticsModal(courseId) {
        const course = DB.getCourses().find(c => c.id === courseId);
        document.getElementById('analytics-course-name').textContent = course.name;
        const enrollments = DB.getEnrollments().filter(e => e.courseId === courseId);
        const grades = enrollments.map(e => parseFloat(calculateCourseGrade(e.grades).numeric)).filter(g => g !== null && !isNaN(g));
        const gradeDistribution = { '1.00-1.75': 0, '2.00-2.75': 0, '3.00': 0, 'Failed': 0 };
        grades.forEach(g => { if (g <= 1.75) gradeDistribution['1.00-1.75']++; else if (g <= 2.75) gradeDistribution['2.00-2.75']++; else if (g <= 3.00) gradeDistribution['3.00']++; else gradeDistribution['Failed']++; });
        const ctx = document.getElementById('grade-distribution-chart').getContext('2d');
        if (gradeChart) gradeChart.destroy();
        gradeChart = new Chart(ctx, { type: 'pie', data: { labels: Object.keys(gradeDistribution), datasets: [{ label: 'Grade Distribution', data: Object.values(gradeDistribution), backgroundColor: ['#003366', '#3b82f6', '#93c5fd', '#ef4444'], }] }, });
        const classAverage = grades.length > 0 ? formatGrade(grades.reduce((a, b) => a + b, 0) / grades.length) : 'N/A';
        const passRate = grades.length > 0 ? ((grades.filter(g => g <= 3.0).length / grades.length) * 100).toFixed(0) : 'N/A';
        document.getElementById('analytics-summary').innerHTML = `<p><strong>Class Average:</strong> ${classAverage}</p><p><strong>Pass Rate:</strong> ${passRate}%</p><p><strong>Total Students:</strong> ${grades.length}</p>`;
        openModal('class-analytics-modal');
    }

    // --- PDF Generation ---
    function downloadDiploma() {
        const user = DB.getCurrentUser();
        const { gpa } = calculateGPA(user.details.id);
        const honor = determineLatinHonors(parseFloat(gpa));
        const doc = new jsPDF();
        doc.setFont('times', 'bold');
        doc.setFontSize(26);
        doc.text("University of Digital Scholars", 105, 40, null, null, 'center');
        doc.setFontSize(16);
        doc.setFont('times', 'normal');
        doc.text("Be it known that", 105, 70, null, null, 'center');
        doc.setFontSize(22);
        doc.setFont('times', 'bold');
        doc.text(user.details.name, 105, 90, null, null, 'center');
        doc.setFontSize(16);
        doc.setFont('times', 'normal');
        doc.text("having completed the prescribed course of study and having satisfied all", 105, 110, null, null, 'center');
        doc.text("the requirements for graduation, has this day been admitted to the degree of", 105, 120, null, null, 'center');
        doc.setFontSize(20);
        doc.setFont('times', 'bold');
        doc.text(user.details.program, 105, 140, null, null, 'center');
        if(honor) {
            doc.setFontSize(16);
            doc.setFont('times', 'italic');
            doc.text(`with the distinction of ${honor}`, 105, 155, null, null, 'center');
        }
        doc.setFontSize(12);
        doc.setFont('times', 'normal');
        doc.text(`Given this ${new Date(user.graduationDate).toLocaleDateString('en-US', { day: 'numeric', month: 'long', year: 'numeric' })}.`, 105, 180, null, null, 'center');
        doc.save(`${user.details.name}-Diploma.pdf`);
    }
    function downloadTranscript() {
        const user = DB.getCurrentUser();
        const doc = new jsPDF();
        doc.setFontSize(18);
        doc.text("Official Transcript of Records", 105, 15, null, null, 'center');
        doc.setFontSize(12);
        doc.text(`Name: ${user.details.name}`, 14, 30);
        doc.text(`Program: ${user.details.program}`, 14, 37);
        doc.text(`Student ID: ${user.details.id}`, 14, 44);
        
        let y = 55;
        const allCourses = DB.getCourses();
        const enrollments = DB.getEnrollments().filter(e => e.studentId === user.details.id);

        for (let yr = 1; yr <= 4; yr++) {
            doc.setFontSize(14);
            doc.setFont('helvetica', 'bold');
            doc.text(`${yr}${yr === 1 ? 'st' : yr === 2 ? 'nd' : yr === 3 ? 'rd' : 'th'} Year`, 14, y);
            y += 7;
            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            const yearEnrollments = enrollments.filter(e => allCourses.find(c => c.id === e.courseId)?.year == yr);
            yearEnrollments.forEach(e => {
                if (y > 280) { doc.addPage(); y = 15; }
                const course = allCourses.find(c => c.id === e.courseId);
                const grade = calculateCourseGrade(e.grades);
                doc.text(`${course.code}`, 20, y);
                doc.text(`${course.name}`, 50, y);
                doc.text(`${grade.numeric || 'INC'}`, 180, y, null, null, 'right');
                y += 6;
            });
            y += 4;
        }

        const { gpa } = calculateGPA(user.details.id);
        doc.setFontSize(12);
        doc.setFont('helvetica', 'bold');
        doc.text(`Final GPA: ${gpa}`, 14, y);
        doc.save(`${user.details.name}-Transcript.pdf`);
    }

    // --- Dynamic Dropdowns ---
    function populateProfessorDropdown() { const professors = DB.getUsers().filter(u => u.role === 'professor'); const select = document.getElementById('course-professor'); select.innerHTML = '<option value="" disabled selected>Select a Professor</option>'; professors.forEach(p => { select.innerHTML += `<option value="${p.details.id}">${p.details.name}</option>`; }); }

    // --- Initial Load ---
    document.addEventListener('DOMContentLoaded', () => { DB.init(); const currentUser = DB.getCurrentUser(); if (currentUser) { handleLogin(); } else { showPage('login-page'); } });
    </script>
</body>
</html>
